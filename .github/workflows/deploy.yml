name: Build & Deploy

on:
  push:
    branches: [main]

jobs:
  # ---- Job 1: Test ----
  test:
    runs-on: ubuntu-latest
    
    # Add Redis service for integration tests
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Set up test environment
        run: |
          echo "JWT_SECRET=test-secret-key-for-ci" >> $GITHUB_ENV
          echo "SERVER_URL=http://localhost:8080" >> $GITHUB_ENV
          echo "REDIS_ADDR=localhost:6379" >> $GITHUB_ENV
          echo "REDIS_PASSWORD=" >> $GITHUB_ENV
      
      - name: Run tests with coverage
        run: |
          go test -v -coverprofile=coverage.out -covermode=atomic ./...
      
      - name: Display coverage summary
        run: |
          go tool cover -func=coverage.out
      
      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 50" | bc -l) )); then
            echo "âŒ Coverage is below 50% threshold"
            exit 1
          else
            echo "âœ… Coverage meets threshold"
          fi

  # ---- Job 2: Deploy (only if tests pass) ----
  deploy:
    needs: test
    runs-on: ubuntu-latest
    environment: OCI              
    steps:
      - name: Deploy to OCI
        id: deploy
        uses: appleboy/ssh-action@master
        timeout-minutes: 10
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USER }}
          key: ${{ secrets.OCI_SSH_KEY }}
          script: |
            set -e
            cd ~/apps/url-shortener-be

            echo "Creating backup..."
            docker compose ps > /tmp/pre-deploy-state.txt

            echo "Pulling latest code..."
            git pull origin main

            echo "Deploying new version..."
            docker compose down
            docker compose up -d --build
            docker image prune -f

            echo "Deployment completed successfully"

      - name: Health Check
        uses: appleboy/ssh-action@master
        timeout-minutes: 2
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USER }}
          key: ${{ secrets.OCI_SSH_KEY }}
          script: |
            echo "Waiting for services to start..."
            sleep 15

            if curl -f http://localhost:8080/test/ping; then
              echo "App is healthy"
              exit 0
            else
              echo "App health check failed"
              exit 1
            fi

      - name: Rollback on Failure
        if: failure() && steps.deploy.outcome == 'success'
        uses: appleboy/ssh-action@master
        timeout-minutes: 5
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USER }}
          key: ${{ secrets.OCI_SSH_KEY }}
          script: |
            echo "Deployment failed, rolling back..."
            cd ~/apps/url-shortener-be
            git reset --hard HEAD~1
            docker compose down
            docker compose up -d --build
            echo "âœ… Rollback completed"    # ðŸ‘ˆ FIX 2 - removed the '1'
